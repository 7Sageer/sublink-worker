
    <!DOCTYPE html>
    <html lang="en">
      
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sublink Worker - Subscription Link Converter Tool">
    <meta name="keywords" content="subscription link, convert, Xray, SingBox, Clash, Surge">
    <title>Sublink Worker - Subscription Link Converter Tool</title>
    <meta property="og:title" content="Sublink Worker - Subscription Link Converter Tool">
    <meta property="og:description" content="A powerful subscription link converter supporting multiple client formats">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://generate-sublink.benxx.workers.dev/">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
      
  :root {
    --bg-color: #f0f2f5;
    --text-color: #495057;
    --card-bg: #ffffff;
    --card-header-bg: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    --btn-primary-bg: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    --input-bg: #ffffff;
    --input-border: #ced4da;
    --input-text: #495057;
    --placeholder-color: #6c757d;
    --section-border: rgba(0, 0, 0, 0.1);
    --section-bg: rgba(0, 0, 0, 0.02);
    --select-bg: #ffffff;
    --select-text: #495057;
    --select-border: #ced4da;
    --dropdown-bg: #ffffff;
    --dropdown-text: #495057;
    --dropdown-hover-bg: #f8f9fa;
    --dropdown-hover-text: #495057;
    --switch-bg: #e9ecef;
    --switch-checked-bg: #6a11cb;
    --transition-speed: 0.3s;
    --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
  }

  [data-theme="dark"] {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --card-bg: #2c2c2c;
    --card-header-bg: linear-gradient(135deg, #4a0e8f 0%, #1a5ab8 100%);
    --btn-primary-bg: linear-gradient(135deg, #4a0e8f 0%, #1a5ab8 100%);
    --input-bg: #3c3c3c;
    --input-border: #555555;
    --input-text: #e0e0e0;
    --placeholder-color: #adb5bd;
    --section-border: rgba(255, 255, 255, 0.1);
    --section-bg: rgba(255, 255, 255, 0.02);
    --select-bg: #3c3c3c;
    --select-text: #e0e0e0;
    --select-border: #555555;
    --dropdown-bg: #2c2c2c;
    --dropdown-text: #e0e0e0;
    --dropdown-hover-bg: #3c3c3c;
    --dropdown-hover-text: #e0e0e0;
    --switch-bg: #555555;
    --switch-checked-bg: #4a0e8f;
  }

  .container { max-width: 800px; }

  body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    transition: background-color 0.3s var(--transition-timing), color 0.3s var(--transition-timing);
  }

  .card {
    background-color: var(--card-bg);
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .card-header {
    background: var(--card-header-bg);
    color: white;
    border-radius: 15px 15px 0 0;
    padding: 2.5rem 2rem;
    border-bottom: 1px solid var(--section-border);
  }

  .card-body {
    padding: 2rem;
  }

  .form-section {
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--section-border);
    border-radius: 10px;
    background: var(--section-bg);
  }

  /* Ensure form button containers have proper spacing */
  .card-body .d-flex {
    margin-left: 0;
    margin-right: 0;
  }

  /* Target the convert/clear button container specifically */
  /* Ensure consistent spacing with other form elements */
  .card-body > form > .d-flex.gap-2.mt-4 {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  .button-container {
    margin-left: 1.5rem !important;
    margin-right: 1.5rem !important;
    padding: 0;
    border: none;
    background: none;
  }
    
  .form-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color);
  }

  .input-group {
    margin-bottom: 1rem;
  }

  .form-control, .form-select {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: #6a11cb;
    box-shadow: 0 0 0 0.2rem rgba(106, 17, 203, 0.25);
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: var(--btn-primary-bg);
    border: none;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(106, 17, 203, 0.2);
  }

  .input-group-text, .form-control {
    background-color: var(--input-bg);
    border-color: var(--input-border);
    color: var(--input-text);
  }

  .form-control:focus {
    background-color: var(--input-bg);
    color: var(--input-text);
    box-shadow: 0 0 0 0.2rem rgba(106, 17, 203, 0.25);
  }

  .input-group { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04); }

  h2, h4 {
    color: var(--text-color);
    font-weight: 600;
  }

  h5 {
    color: var(--text-color);
    font-weight: 500;
  }

  .form-label {
    font-weight: 500;
    color: var(--text-color);
  }

  .btn-outline-secondary {
    color: var(--text-color);
    border-color: var(--input-border);
  }

  .btn-outline-secondary:hover {
    background-color: var(--input-bg);
    color: var(--text-color);
  }

  .btn-success {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
  }

  .btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
  }

  #darkModeToggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    color: var(--text-color);
    border-color: var(--input-border);
    background-color: var(--card-bg);
    transition: all 0.3s var(--transition-timing);
  }

  #darkModeToggle:hover {
    background-color: var(--dropdown-hover-bg);
    border-color: var(--text-color);
    color: var(--text-color);
  }

  .github-link {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    font-size: 2rem;
    color: var(--text-color);
    transition: color 0.3s ease;
  }

  .github-link:hover { color: #6a11cb; }
  
  .tooltip-icon {
    cursor: pointer;
    margin-left: 5px;
    color: var(--text-color);
    position: relative;
    display: inline-block;
    vertical-align: super;
    font-size: 1em;
  }

  .question-mark {
    display: inline-block;
    width: 16px;
    height: 16px;
    line-height: 16px;
    text-align: center;
    border-radius: 50%;
    background-color: var(--text-color);
    color: var(--card-bg);
  }

  .tooltip-content {
    visibility: hidden;
    opacity: 0;
    background-color: var(--card-bg);
    position: fixed;
    background-color: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--input-border);
    border-radius: 6px;
    padding: 10px;
    z-index: 1000;
    width: 180px;
    max-width: 90vw;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    transition: opacity 0.3s, visibility 0.3s;
  }

  .tooltip-icon:hover .tooltip-content {
    visibility: visible;
    opacity: 1;
  }

  @media (max-width: 768px) {
    .tooltip-content {
      width: 250px;
      left: auto;
      right: 0;
      transform: none;
    }
  }

  .form-check-input {
    background-color: var(--checkbox-bg);
    border-color: var(--checkbox-border);
  }

  .form-check-input:checked {
    background-color: var(--checkbox-checked-bg);
    border-color: var(--checkbox-checked-border);
  }

  .form-check-label {
    color: var(--text-color);
  }
  .explanation-text {
    background-color: var(--explanation-bg);
    color: var(--explanation-text);
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .form-select {
    background-color: var(--select-bg);
    color: var(--select-text);
    border-color: var(--select-border);
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;

    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23495057' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1em;
    padding-right: 2.5em;
  }

  [data-theme="dark"] .form-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  }

  .form-select:focus {
    background-color: var(--select-bg);
    color: var(--select-text);
    border-color: var(--checkbox-checked-border);
    box-shadow: 0 0 0 0.2rem rgba(106, 17, 203, 0.25);
  }

  .form-control::placeholder {
    color: var(--placeholder-color);
    opacity: 1;
  }

  .form-control::-webkit-input-placeholder {
    color: var(--placeholder-color);
    opacity: 1;
  }

  .form-control::-moz-placeholder {
    color: var(--placeholder-color);
    opacity: 1;
  }

  .form-control:-ms-input-placeholder {
    color: var(--placeholder-color);
    opacity: 1;
  }

  .form-control::-ms-input-placeholder {
    color: var(--placeholder-color);
    opacity: 1;
  }

  #advancedOptions {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transform: translateY(-20px);
    transition: max-height 0.5s var(--transition-timing),
                opacity 0.3s var(--transition-timing),
                transform 0.3s var(--transition-timing);
  }

  #advancedOptions.show {
    max-height: none;
    opacity: 1;
    transform: translateY(0);
    overflow: visible;
  }

  /* Custom Rules Section */
  .custom-rules-section {
    margin-bottom: 1.5rem;
  }

  .custom-rules-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--section-border);
  }

  .custom-rules-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
    margin-right: 0.5rem;
  }

  /* Custom Rules Container Styling */
  .custom-rules-container {
    border: 1px solid var(--input-border);
    border-radius: 10px;
    background-color: var(--card-bg);
    overflow: hidden;
  }

  #customRules, #customRulesJSON {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1rem;
    background-color: var(--input-bg);
  }

  #customRules:empty, #customRulesJSON:empty {
    padding: 0;
  }

  /* Custom Rules Section Header */
  .custom-rules-section-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--section-border);
  }

  .custom-rules-section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
    margin-right: 0.75rem;
  }

  /* Custom Rules Tabs */
  .custom-rules-tabs {
    display: flex;
    border-bottom: 2px solid var(--input-border);
    background-color: var(--card-bg);
  }

  .custom-rules-tab {
    flex: 1;
    padding: 0.875rem 1rem;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-color);
    transition: all 0.3s var(--transition-timing);
    border-bottom: 3px solid transparent;
    font-size: 0.95rem;
  }

  .custom-rules-tab:hover {
    background-color: var(--dropdown-hover-bg);
    color: var(--dropdown-hover-text);
  }

  .custom-rules-tab.active {
    color: #6a11cb;
    border-bottom-color: #6a11cb;
    background-color: var(--dropdown-hover-bg);
    font-weight: 600;
  }

  /* Dark mode specific adjustments for custom rules tabs */
  [data-theme="dark"] .custom-rules-tab {
    color: var(--text-color);
  }

  [data-theme="dark"] .custom-rules-tab:hover {
    background-color: var(--dropdown-hover-bg);
    color: var(--dropdown-hover-text);
  }

  [data-theme="dark"] .custom-rules-tab.active {
    color: #8a4fff;
    border-bottom-color: #8a4fff;
    background-color: var(--dropdown-hover-bg);
  }

  .custom-rules-content {
    min-height: 200px;
  }

  .custom-rules-view {
    display: none;
  }

  .custom-rules-view.active {
    display: block;
  }

  /* Conversion Controls */
  .conversion-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding: 0.875rem;
    background-color: var(--section-bg);
    border-radius: 8px;
    border: 1px solid var(--section-border);
  }

  .conversion-controls .btn {
    font-size: 0.875rem;
    padding: 0.5rem 0.875rem;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    transition: all 0.3s var(--transition-timing);
  }

  .conversion-controls .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .conversion-controls .btn-outline-primary {
    border-color: #6a11cb;
    color: #6a11cb;
    background-color: transparent;
  }

  .conversion-controls .btn-outline-primary:hover {
    background-color: #6a11cb;
    border-color: #6a11cb;
    color: white;
  }

  .conversion-controls .btn-outline-secondary {
    border-color: var(--input-border);
    color: var(--text-color);
    background-color: transparent;
  }

  .conversion-controls .btn-outline-secondary:hover {
    background-color: var(--dropdown-hover-bg);
    border-color: var(--text-color);
    color: var(--text-color);
  }

  .conversion-controls .btn-outline-info {
    border-color: #17a2b8;
    color: #17a2b8;
    background-color: transparent;
  }

  .conversion-controls .btn-outline-info:hover {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
  }

  .conversion-controls .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
    background-color: transparent;
  }

  .conversion-controls .btn-outline-danger:hover {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
  }

  /* Dark mode specific button adjustments */
  [data-theme="dark"] .conversion-controls .btn-outline-primary {
    border-color: #8a4fff;
    color: #8a4fff;
  }

  [data-theme="dark"] .conversion-controls .btn-outline-primary:hover {
    background-color: #8a4fff;
    border-color: #8a4fff;
    color: white;
  }

  [data-theme="dark"] .conversion-controls .btn-outline-secondary {
    border-color: var(--input-border);
    color: var(--text-color);
  }

  [data-theme="dark"] .conversion-controls .btn-outline-secondary:hover {
    background-color: var(--dropdown-hover-bg);
    border-color: var(--text-color);
    color: var(--text-color);
  }

  [data-theme="dark"] .conversion-controls .btn-outline-info {
    border-color: #20c997;
    color: #20c997;
  }

  [data-theme="dark"] .conversion-controls .btn-outline-info:hover {
    background-color: #20c997;
    border-color: #20c997;
    color: white;
  }

  [data-theme="dark"] .conversion-controls .btn-outline-danger {
    border-color: #ff6b6b;
    color: #ff6b6b;
  }

  [data-theme="dark"] .conversion-controls .btn-outline-danger:hover {
    background-color: #ff6b6b;
    border-color: #ff6b6b;
    color: white;
  }

  /* Empty State Messages */
  .empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--placeholder-color);
    background-color: var(--section-bg);
    border-radius: 8px;
    margin: 1rem;
  }

  .empty-state i {
    color: var(--placeholder-color);
    margin-bottom: 0.75rem;
  }

  .empty-state p {
    margin: 0;
    font-size: 0.95rem;
  }

  /* JSON Validation States */
  .json-valid {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
  }

  .json-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
  }

  .json-validation-message {
    font-size: 0.875rem;
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.3s var(--transition-timing);
  }

  .json-validation-message.valid {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
  }

  .json-validation-message.invalid {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
  }

  /* Dark mode support for validation messages */
  [data-theme="dark"] .json-validation-message.valid {
    color: #75b798;
    background-color: rgba(40, 167, 69, 0.2);
    border: 1px solid rgba(40, 167, 69, 0.3);
  }

  [data-theme="dark"] .json-validation-message.invalid {
    color: #f1aeb5;
    background-color: rgba(220, 53, 69, 0.2);
    border: 1px solid rgba(220, 53, 69, 0.3);
  }

  .json-textarea-container {
    position: relative;
  }

  /* Custom Rule Cards */
  .custom-rule, .custom-rule-json {
    margin-bottom: 1rem;
    border: 1px solid var(--input-border);
    border-radius: 8px;
    background-color: var(--card-bg);
    transition: all 0.3s var(--transition-timing);
    padding: 1rem;
  }

  .custom-rule:hover, .custom-rule-json:hover {
    border-color: #6a11cb;
    box-shadow: 0 2px 8px rgba(106, 17, 203, 0.1);
  }

  .custom-rule h6, .custom-rule-json h6 {
    color: var(--text-color);
    font-weight: 600;
    margin: 0;
  }

  .custom-rule .form-label, .custom-rule-json .form-label {
    color: var(--text-color);
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .custom-rule .form-control, .custom-rule-json .form-control {
    background-color: var(--input-bg);
    border-color: var(--input-border);
    color: var(--text-color);
  }

  .custom-rule .form-control:focus, .custom-rule-json .form-control:focus {
    background-color: var(--input-bg);
    border-color: #6a11cb;
    color: var(--text-color);
    box-shadow: 0 0 0 0.2rem rgba(106, 17, 203, 0.25);
  }

  .custom-rule .form-control::placeholder, .custom-rule-json .form-control::placeholder {
    color: var(--placeholder-color);
  }

  /* Dark mode specific adjustments for custom rule cards */
  [data-theme="dark"] .custom-rule:hover,
  [data-theme="dark"] .custom-rule-json:hover {
    border-color: #8a4fff;
    box-shadow: 0 2px 8px rgba(138, 79, 255, 0.2);
  }

  [data-theme="dark"] .custom-rule .form-control:focus,
  [data-theme="dark"] .custom-rule-json .form-control:focus {
    border-color: #8a4fff;
    box-shadow: 0 0 0 0.2rem rgba(138, 79, 255, 0.25);
  }

  .header-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
  }
  .header-title {
      margin: 0;
      margin-right: 10px;
  }

  .qr-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s var(--transition-timing),
                visibility 0.3s var(--transition-timing);
    z-index: 1000;
  }

  .qr-modal.show {
    opacity: 1;
    visibility: visible;
  }

  .qr-card {
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    text-align: center;
    transform: scale(0.9) translateY(20px);
    transition: transform 0.3s var(--transition-timing);
  }

  .qr-modal.show .qr-card {
    transform: scale(1) translateY(0);
  }

  .qr-card img {
    max-width: 100%;
    height: auto;
  }

  .qr-card p {
    margin-top: 10px;
    color: #333;
    font-size: 16px;
  }

  .base-url-label {
    background-color: var(--input-bg);
    color: var(--input-text);
    border: 1px solid var(--input-border);
    border-radius: 0.25rem;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
  }

  #subscribeLinksContainer {
    max-height: 0;
    opacity: 0;
    transform: translateY(20px);
    transition: max-height 0.5s var(--transition-timing),
                opacity 0.3s var(--transition-timing),
                transform 0.3s var(--transition-timing);
    padding: 1.5rem 1.5rem;
  }

  #subscribeLinksContainer.show {
    max-height: 1000px;
    opacity: 1;
    transform: translateY(0);
  }

  #subscribeLinksContainer.hide {
    max-height: 0;
    opacity: 0;
  }

  #subscribeLinksContainer .mb-4 {
    margin-bottom: 1.5rem !important;
  }

  #subscribeLinksContainer .mt-4 {
    margin-top: 1.5rem !important;
  }

  #subscribeLinksContainer .mt-3 {
    margin-top: 1.25rem !important;
  }

  #subscribeLinksContainer .mb-5 {
    margin-bottom: 1.5rem !important;
  }

  #subscribeLinksContainer .mt-5 {
    margin-top: 1.5rem !important;
  }

  /* Add consistent spacing between link sections */
  #subscribeLinksContainer .input-group {
    margin-bottom: 0.5rem;
    margin-left: 0;
    margin-right: 0;
  }

  #subscribeLinksContainer .form-label {
    margin-bottom: 0.75rem;
    font-weight: 500;
    color: var(--text-color);
  }

  /* Ensure proper spacing for all form elements within the container */
  #subscribeLinksContainer .mb-4 {
    padding-left: 0;
    padding-right: 0;
  }

  /* Ensure all button containers within cards have proper spacing */
  /* Fix button container spacing without interfering with gap-2 */
  .card-body .d-grid {
    margin-left: 1.5rem !important;
    margin-right: 1.5rem !important;
  }

  /* Form sections should not add extra padding to button containers */
  .form-section .d-flex.gap-2 {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  /* Add subtle visual separation between sections */
  #subscribeLinksContainer > div:not(:last-child) {
    border-bottom: 1px solid var(--input-border);
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
  }

  /* Remove border from the button container and ensure proper spacing */
  #subscribeLinksContainer .d-grid {
    border-bottom: none !important;
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  /* Responsive spacing adjustments */
  @media (max-width: 768px) {
    #subscribeLinksContainer {
      padding: 1rem 1rem !important;
    }

    #subscribeLinksContainer .mb-4 {
      margin-bottom: 1rem !important;
    }

    #subscribeLinksContainer .mt-4 {
      margin-top: 1rem !important;
    }

    #subscribeLinksContainer .mt-3 {
      margin-top: 0.75rem !important;
    }

    #subscribeLinksContainer .mb-5 {
      margin-bottom: 1rem !important;
    }

    #subscribeLinksContainer .mt-5 {
      margin-top: 1rem !important;
    }

    /* Adjust button container spacing for mobile */
    .card-body .d-grid {
      margin-left: 1rem !important;
      margin-right: 1rem !important;
    }

    /* Form sections should not add extra spacing on mobile */
    .form-section .d-flex.gap-2 {
      margin-left: 0 !important;
      margin-right: 0 !important;
    }

    /* Add horizontal margin to main form button containers on mobile */
    .card-body > form > .d-flex.gap-2.mt-4,
    .card-body .d-flex.gap-2.mt-4 {
      margin-left: 1rem !important;
      margin-right: 1rem !important;
    }
  }

  .form-select option {
    background-color: var(--dropdown-bg);
    color: var(--dropdown-text);
  }

  .form-select option:hover {
    background-color: var(--dropdown-hover-bg);
    color: var(--dropdown-hover-text);
  }

  .form-check-input {
    background-color: var(--switch-bg);
    border-color: var(--switch-border);
  }

  .form-check-input:checked {
    background-color: var(--switch-checked-bg);
    border-color: var(--switch-checked-bg);
  }

  .dropdown-menu {
    background-color: var(--dropdown-bg);
    border-color: var(--select-border);
  }

  .dropdown-item {
    color: var(--dropdown-text);
  }

  .dropdown-item:hover,
  .dropdown-item:focus {
    background-color: var(--dropdown-hover-bg);
    color: var(--dropdown-hover-text);
  }

  /* é€šç”¨è¿‡æ¸¡æ•ˆæœ */
  .card,
  .btn,
  .form-control,
  .form-select,
  .input-group,
  .tooltip-content,
  .github-link,
  .qr-modal,
  .qr-card {
    transition: all var(--transition-speed) var(--transition-timing);
  }

  /* é«˜çº§é€‰é¡¹å±•å¼€/æ”¶èµ·åŠ¨ç”» - Updated to remove height constraints */
  #advancedOptions {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transform: translateY(-20px);
    transition: max-height 0.5s var(--transition-timing),
                opacity 0.3s var(--transition-timing),
                transform 0.3s var(--transition-timing);
  }

  #advancedOptions.show {
    max-height: none;
    opacity: 1;
    transform: translateY(0);
    overflow: visible;
  }



  /* æŒ‰é’®æ‚¬åœåŠ¨ç”» */
  .btn {
    transform: translateY(0);
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  /* å¤åˆ¶æŒ‰é’®æˆåŠŸåŠ¨ç”» */
  @keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .btn-success {
    animation: successPulse 0.3s var(--transition-timing);
  }

  /* QRç æ¨¡æ€æ¡†åŠ¨ç”» */
  .qr-modal {
    opacity: 0;
    visibility: hidden;
    backdrop-filter: blur(5px);
    transition: opacity 0.3s var(--transition-timing),
                visibility 0.3s var(--transition-timing);
  }

  .qr-modal.show {
    opacity: 1;
    visibility: visible;
  }

  .qr-card {
    transform: scale(0.9) translateY(20px);
    transition: transform 0.3s var(--transition-timing);
  }

  .qr-modal.show .qr-card {
    transform: scale(1) translateY(0);
  }

  /* è‡ªå®šä¹‰è§„åˆ™æ·»åŠ /åˆ é™¤åŠ¨ç”» */
  .custom-rule {
    opacity: 0;
    transform: translateY(20px);
    animation: slideIn 0.3s var(--transition-timing) forwards;
  }

  .custom-rule.removing {
    animation: slideOut 0.3s var(--transition-timing) forwards;
  }

  @keyframes slideIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-20px);
    }
  }

  /* æš—è‰²æ¨¡å¼åˆ‡æ¢åŠ¨ç”» */
  body {
    transition: background-color 0.3s var(--transition-timing),
                color 0.3s var(--transition-timing);
  }

  /* å·¥å…·æç¤ºåŠ¨ç”» */
  .tooltip-content {
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: opacity 0.3s var(--transition-timing),
                visibility 0.3s var(--transition-timing),
                transform 0.3s var(--transition-timing);
  }

  .tooltip-icon:hover .tooltip-content {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

    </style>
  </head>

      
  <body>
    
  <button id="darkModeToggle" class="btn btn-outline-secondary">
    <i class="fas fa-moon"></i>
  </button>

    
  <a href="https://t.me/Blesh" target="_blank" rel="noopener noreferrer" class="telegram-link">
    <i class="fab fa-telegram"></i>
  </a>

    <div class="container mt-5">
      <div class="card mb-5">
        
  <div class="card-header text-center">
    <h1 class="display-4 mb-0">Generate Sublink</h1>
  </div>

        <div class="card-body">
          
  <form method="POST" id="encodeForm">
    
  <div class="form-section">
    <div class="form-section-title">Share Links</div>
    <textarea class="form-control" id="inputTextarea" name="input" required placeholder="Enter the share link here (you can paste a previously generated link to quickly parse the configuration)..." rows="3"></textarea>
  </div>

    
  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="advancedToggle">
    <label class="form-check-label" for="advancedToggle">Advanced Options</label>
  </div>

    
  <div id="advancedOptions">
    
  <div class="form-section">
    <div class="form-section-title d-flex align-items-center">
      Rule Selection
      <span class="tooltip-icon ms-2">
        <i class="fas fa-question-circle"></i>
        <span class="tooltip-content">
          Select the rule sets you need
        </span>
      </span>
    </div>
    <div class="content-container mb-3">
      <select class="form-select" id="predefinedRules" onchange="applyPredefinedRules()">
        <option value="custom">Custom</option>
        <option value="minimal">Minimal</option>
        <option value="balanced">Balanced</option>
        <option value="comprehensive">Comprehensive</option>
      </select>
    </div>
    <div class="row" id="ruleCheckboxes">
      
  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Ad Block" id="Ad Block" name="selectedRules">
      <label class="form-check-label" for="Ad Block">ğŸ›‘ Ad Blocking</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="AI Services" id="AI Services" name="selectedRules">
      <label class="form-check-label" for="AI Services">ğŸ’¬ AI Services</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Bilibili" id="Bilibili" name="selectedRules">
      <label class="form-check-label" for="Bilibili">ğŸ“º Bilibili</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Youtube" id="Youtube" name="selectedRules">
      <label class="form-check-label" for="Youtube">ğŸ“¹ Youtube</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Google" id="Google" name="selectedRules">
      <label class="form-check-label" for="Google">ğŸ” Google Services</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Private" id="Private" name="selectedRules">
      <label class="form-check-label" for="Private">ğŸ  Private Network</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Location:CN" id="Location:CN" name="selectedRules">
      <label class="form-check-label" for="Location:CN">ğŸ”’ China Services</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Telegram" id="Telegram" name="selectedRules">
      <label class="form-check-label" for="Telegram">ğŸ“² Telegram</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Github" id="Github" name="selectedRules">
      <label class="form-check-label" for="Github">ğŸ± Github</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Microsoft" id="Microsoft" name="selectedRules">
      <label class="form-check-label" for="Microsoft">â“‚ï¸ Microsoft Services</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Apple" id="Apple" name="selectedRules">
      <label class="form-check-label" for="Apple">ğŸ Apple Services</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Social Media" id="Social Media" name="selectedRules">
      <label class="form-check-label" for="Social Media">ğŸŒ Social Media</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Streaming" id="Streaming" name="selectedRules">
      <label class="form-check-label" for="Streaming">ğŸ¬ Streaming</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Gaming" id="Gaming" name="selectedRules">
      <label class="form-check-label" for="Gaming">ğŸ® Gaming Platform</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Education" id="Education" name="selectedRules">
      <label class="form-check-label" for="Education">ğŸ“š Education Resources</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Financial" id="Financial" name="selectedRules">
      <label class="form-check-label" for="Financial">ğŸ’° Financial Services</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Cloud Services" id="Cloud Services" name="selectedRules">
      <label class="form-check-label" for="Cloud Services">â˜ï¸ Cloud Services</label>
    </div>
  </div>

  <div class="col-md-4 mb-2">
    <div class="form-check">
      <input class="form-check-input rule-checkbox" type="checkbox" value="Non-China" id="Non-China" name="selectedRules">
      <label class="form-check-label" for="Non-China">ğŸŒ Non-China</label>
    </div>
  </div>

    </div>
    
  <div class="mt-2">
    <div class="custom-rules-section-header">
      <h5 class="custom-rules-section-title">Custom Rules</h5>
      <span class="tooltip-icon">
        <i class="fas fa-question-circle"></i>
        <span class="tooltip-content">
          Create custom routing rules to control traffic behavior. Supports both form and JSON editing, which are interchangeable.
        </span>
      </span>
    </div>
    <div class="custom-rules-container">
      
  <div class="custom-rules-tabs">
    <button type="button" class="custom-rules-tab active" onclick="switchCustomRulesTab('form')" id="formTab">
      <i class="fas fa-edit me-2"></i>Form View
    </button>
    <button type="button" class="custom-rules-tab" onclick="switchCustomRulesTab('json')" id="jsonTab">
      <i class="fas fa-code me-2"></i>JSON View
    </button>
  </div>

      
  <div class="custom-rules-content">
    
  <div id="formView" class="custom-rules-view active">
    <div class="conversion-controls">
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCustomRule()">
        <i class="fas fa-plus me-1"></i>Add Custom Rule
      </button>
      <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAllCustomRules()">
        <i class="fas fa-trash me-1"></i>Clear All
      </button>
    </div>
    <div id="customRules">
      <!-- Custom rules will be dynamically added here -->
    </div>
    <div id="emptyFormMessage" class="empty-state" style="display: none;">
      <i class="fas fa-plus-circle fa-2x mb-2"></i>
      <p>Click "Add Custom Rule" to start creating rules</p>
    </div>
  </div>

    
  <div id="jsonView" class="custom-rules-view">
    <div class="conversion-controls">
      <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAllCustomRules()">
        <i class="fas fa-trash me-1"></i>Clear All
      </button>
    </div>
    <div id="customRulesJSON">
      <div class="mb-2">
        <label class="form-label">JSON Rule</label>
        <div class="json-textarea-container">
          <textarea class="form-control json-textarea" name="customRuleJSON[]" rows="15"
                    oninput="validateJSONRealtime(this)"></textarea>
          <div class="json-validation-message" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  </div>

    </div>
  </div>

  </div>

    
  <div class="form-section">
    <div class="form-section-title d-flex align-items-center">
      Base Configuration Settings
      <span class="tooltip-icon ms-2">
        <i class="fas fa-question-circle"></i>
        <span class="tooltip-content">
          Customize your base configuration here
        </span>
      </span>
    </div>
    <div class="mb-3">
      <select class="form-select" id="configType">
        <option value="singbox">SingBox (JSON)</option>
        <option value="clash">Clash (YAML)</option>
      </select>
    </div>
    <div class="mb-3">
      <textarea class="form-control" id="configEditor" rows="3" placeholder="Paste your custom config here..."></textarea>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-secondary" onclick="saveConfig()">Save Configuration</button>
      <button type="button" class="btn btn-outline-danger" onclick="clearConfig()">
        <i class="fas fa-trash-alt me-2"></i>Clear Configuration
      </button>
    </div>
  </div>

    
  <div class="form-section">
    <div class="form-section-title d-flex align-items-center">
      è‡ªå®šä¹‰UserAgent
      <span class="tooltip-icon ms-2">
        <i class="fas fa-question-circle"></i>
        <span class="tooltip-content">
          é»˜è®¤å€¼curl/7.74.0
        </span>
      </span>
    </div>
    <input type="text" class="form-control" id="customUA" placeholder="curl/7.74.0">
  </div>

  </div>

    
  <div class="button-container d-flex gap-2 mt-4">
    <button type="submit" class="btn btn-primary flex-grow-1">
      <i class="fas fa-sync-alt me-2"></i>Convert
    </button>
    <button type="button" class="btn btn-outline-secondary" id="clearFormBtn">
      <i class="fas fa-trash-alt me-2"></i>Clear
    </button>
  </div>

  </form>

          <div id="subscribeLinksContainer">
            
  <div class="mt-4">
    
  <div class="mb-4">
    <label for="xrayLink" class="form-label">Xray Link (Base64):</label>
    <div class="input-group">
      <span class="input-group-text"><i class="fas fa-link"></i></span>
      <input type="text" class="form-control" id="xrayLink" value="" readonly>
      <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('xrayLink')">
        <i class="fas fa-copy"></i>
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="generateQRCode('xrayLink')">
        <i class="fas fa-qrcode"></i>
      </button>
    </div>
  </div>

    
  <div class="mb-4">
    <label for="singboxLink" class="form-label">SingBox Link:</label>
    <div class="input-group">
      <span class="input-group-text"><i class="fas fa-link"></i></span>
      <input type="text" class="form-control" id="singboxLink" value="" readonly>
      <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('singboxLink')">
        <i class="fas fa-copy"></i>
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="generateQRCode('singboxLink')">
        <i class="fas fa-qrcode"></i>
      </button>
    </div>
  </div>

    
  <div class="mb-4">
    <label for="clashLink" class="form-label">Clash Link:</label>
    <div class="input-group">
      <span class="input-group-text"><i class="fas fa-link"></i></span>
      <input type="text" class="form-control" id="clashLink" value="" readonly>
      <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('clashLink')">
        <i class="fas fa-copy"></i>
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="generateQRCode('clashLink')">
        <i class="fas fa-qrcode"></i>
      </button>
    </div>
  </div>

    
  <div class="mb-4">
    <label for="surgeLink" class="form-label">Surge Link:</label>
    <div class="input-group">
      <span class="input-group-text"><i class="fas fa-link"></i></span>
      <input type="text" class="form-control" id="surgeLink" value="" readonly>
      <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('surgeLink')">
        <i class="fas fa-copy"></i>
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="generateQRCode('surgeLink')">
        <i class="fas fa-qrcode"></i>
      </button>
    </div>
  </div>

    
  <div class="mb-4 mt-3">
    <label for="customShortCode" class="form-label">Custom Path</label>
    <div class="input-group flex-nowrap">
      <span class="input-group-text text-truncate" style="max-width: 400px;" title="https://sub.balckwolf.dpdns.org/s/">
        https://sub.balckwolf.dpdns.org/s/
      </span>
      <input type="text" class="form-control" id="customShortCode" placeholder="e.g. my-custom-link">
      <select id="savedCustomPaths" class="form-select" style="max-width: 200px;">
        <option value="">Saved Paths</option>
      </select>
      <button class="btn btn-outline-danger" type="button" onclick="deleteSelectedPath()">
        <i class="fas fa-trash-alt"></i>
      </button>
    </div>
  </div>

    
  <div class="d-grid mt-3">
    <button class="btn btn-primary btn-lg" type="button" onclick="shortenAllUrls()">
      <i class="fas fa-compress-alt me-2"></i>Generate Short Link
    </button>
  </div>

  </div>

          </div>
        </div>
      </div>
    </div>
    
  <script>
    
  function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    
    const button = element.nextElementSibling;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    setTimeout(() => {
      button.innerHTML = originalText;
      button.classList.remove('btn-success');
      button.classList.add('btn-outline-secondary');
    }, 2000);
  }

    
  let isShortening = false;

  async function shortenUrl(url, customShortCode) {
    saveCustomPath();
    const response = await fetch(`/shorten-v2?url=${encodeURIComponent(url)}&shortCode=${encodeURIComponent(customShortCode || '')}`);
    if (response.ok) {
      const data = await response.text();
      return data;
    }
    throw new Error('Failed to shorten URL');
  }

  async function shortenAllUrls() {
    if (isShortening) {
      return;
    }

    const shortenButton = document.querySelector('button[onclick="shortenAllUrls()"]');
    
    try {
      isShortening = true;
      shortenButton.disabled = true;
      shortenButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Shortening...';

      const singboxLink = document.getElementById('singboxLink');
      const customShortCode = document.getElementById('customShortCode').value;

      if (singboxLink.value.includes('/b/')) {
        alert('Links are already shortened!');
        return;
      }

      const shortCode = await shortenUrl(singboxLink.value, customShortCode);

      const xrayLink = document.getElementById('xrayLink');
      const clashLink = document.getElementById('clashLink');
      const surgeLink = document.getElementById('surgeLink');

      xrayLink.value = window.location.origin + '/x/' + shortCode;
      singboxLink.value = window.location.origin + '/b/' + shortCode;
      clashLink.value = window.location.origin + '/c/' + shortCode;
      surgeLink.value = window.location.origin + '/s/' + shortCode;
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to shorten URLs. Please try again.');
    } finally {
      isShortening = false;
      shortenButton.disabled = false;
      shortenButton.innerHTML = '<i class="fas fa-compress-alt me-2"></i>Shorten Links';
    }
  }

    
  const darkModeToggle = document.getElementById('darkModeToggle');
  const body = document.body;

  darkModeToggle.addEventListener('click', () => {
    body.setAttribute('data-theme', body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    darkModeToggle.innerHTML = body.getAttribute('data-theme') === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
  });

  // Check for saved theme preference or use system preference
  const savedTheme = localStorage.getItem('theme');
  const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  if (savedTheme) {
    body.setAttribute('data-theme', savedTheme);
    darkModeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
  } else if (systemDarkMode) {
    body.setAttribute('data-theme', 'dark');
    darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
  }

  // Save theme preference when changed
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
        localStorage.setItem('theme', body.getAttribute('data-theme'));
      }
    });
  });

  observer.observe(body, { attributes: true });

    
  document.getElementById('advancedToggle').addEventListener('change', function() {
    const advancedOptions = document.getElementById('advancedOptions');
    if (this.checked) {
      advancedOptions.classList.add('show');
    } else {
      advancedOptions.classList.remove('show');
    }
  });

    
  function applyPredefinedRules() {
    const predefinedRules = document.getElementById('predefinedRules').value;
    const checkboxes = document.querySelectorAll('.rule-checkbox');
    
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });

    if (predefinedRules === 'custom') {
      return;
    }

    const rulesToApply = {"minimal":["Location:CN","Private","Non-China"],"balanced":["Location:CN","Private","Non-China","Github","Google","Youtube","AI Services","Telegram"],"comprehensive":["Ad Block","AI Services","Bilibili","Youtube","Google","Private","Location:CN","Telegram","Github","Microsoft","Apple","Social Media","Streaming","Gaming","Education","Financial","Cloud Services","Non-China"]};
    
    rulesToApply[predefinedRules].forEach(rule => {
      const checkbox = document.getElementById(rule);
      if (checkbox) {
        checkbox.checked = true;
      }
    });
  }

  // Add event listeners to checkboxes
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.rule-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const predefinedSelect = document.getElementById('predefinedRules');
        if (predefinedSelect.value !== 'custom') {
          predefinedSelect.value = 'custom';
        }
      });
    });
  });

    
  function initTooltips() {
    const tooltips = document.querySelectorAll('.tooltip-icon');
    tooltips.forEach(tooltip => {
      tooltip.addEventListener('click', (e) => {
        e.stopPropagation();
        const content = tooltip.querySelector('.tooltip-content');
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
      });
    });

    document.addEventListener('click', () => {
      const openTooltips = document.querySelectorAll('.tooltip-content[style="display: block;"]');
      openTooltips.forEach(tooltip => {
        tooltip.style.display = 'none';
      });
    });
  }

  document.addEventListener('DOMContentLoaded', initTooltips);

    
  function submitForm(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const inputString = formData.get('input');

    const userAgent = document.getElementById('customUA').value;
    
    // Save form data to localStorage
    localStorage.setItem('inputTextarea', inputString);
    localStorage.setItem('advancedToggle', document.getElementById('advancedToggle').checked);

    // Save UserAgent data to localStorage
    localStorage.setItem('userAgent', document.getElementById('customUA').value);
    
    // Save configEditor and configType to localStorage
    localStorage.setItem('configEditor', document.getElementById('configEditor').value);
    localStorage.setItem('configType', document.getElementById('configType').value);
    
    let selectedRules;
    const predefinedRules = document.getElementById('predefinedRules').value;
    if (predefinedRules !== 'custom') {
      selectedRules = predefinedRules;
    } else {
      selectedRules = Array.from(document.querySelectorAll('input[name="selectedRules"]:checked'))
        .map(checkbox => checkbox.value);
    }
    
    const configEditor = document.getElementById('configEditor');
    const configId = new URLSearchParams(window.location.search).get('configId') || '';

    const customRules = parseCustomRules();

    const configParam = configId ? `&configId=${configId}` : '';
    const xrayUrl = `${window.location.origin}/xray?config=${encodeURIComponent(inputString)}&ua=${encodeURIComponent(userAgent)}${configParam}`;
    const singboxUrl = `${window.location.origin}/singbox?config=${encodeURIComponent(inputString)}&ua=${encodeURIComponent(userAgent)}&selectedRules=${encodeURIComponent(JSON.stringify(selectedRules))}&customRules=${encodeURIComponent(JSON.stringify(customRules))}${configParam}`;
    const clashUrl = `${window.location.origin}/clash?config=${encodeURIComponent(inputString)}&ua=${encodeURIComponent(userAgent)}&selectedRules=${encodeURIComponent(JSON.stringify(selectedRules))}&customRules=${encodeURIComponent(JSON.stringify(customRules))}${configParam}`;
    const surgeUrl = `${window.location.origin}/surge?config=${encodeURIComponent(inputString)}&ua=${encodeURIComponent(userAgent)}&selectedRules=${encodeURIComponent(JSON.stringify(selectedRules))}&customRules=${encodeURIComponent(JSON.stringify(customRules))}${configParam}`;
    document.getElementById('xrayLink').value = xrayUrl;
    document.getElementById('singboxLink').value = singboxUrl;
    document.getElementById('clashLink').value = clashUrl;
    document.getElementById('surgeLink').value = surgeUrl;
    // Show the subscribe part
    const subscribeLinksContainer = document.getElementById('subscribeLinksContainer');
    subscribeLinksContainer.classList.remove('hide');
    subscribeLinksContainer.classList.add('show');

    // Scroll to the subscribe part
    subscribeLinksContainer.scrollIntoView({ behavior: 'smooth' });
  }

  function parseUrlAndFillForm(url) {
    try {
      const urlObj = new URL(url);
      const params = new URLSearchParams(urlObj.search);
      
      // Parse base configuration
      const config = params.get('config');
      if (config) {
        const decodedConfig = decodeURIComponent(config);
        document.getElementById('inputTextarea').value = decodedConfig;
      }

      // Parse UserAgent
      const ua = params.get('ua');
      if (ua) {
        document.getElementById('customUA').value = decodeURIComponent(ua);
      }

      // Parse rule selection
      const selectedRules = params.get('selectedRules');
      if (selectedRules) {
        try {
          const decodedRules = decodeURIComponent(selectedRules).replace(/^"|"$/g, '');
          // Check if it's a predefined rule set
          if (['minimal', 'balanced', 'comprehensive'].includes(decodedRules)) {
            const predefinedRules = document.getElementById('predefinedRules');
            predefinedRules.value = decodedRules;
            // Apply predefined rules to checkboxes
            const rulesToApply = {"minimal":["Location:CN","Private","Non-China"],"balanced":["Location:CN","Private","Non-China","Github","Google","Youtube","AI Services","Telegram"],"comprehensive":["Ad Block","AI Services","Bilibili","Youtube","Google","Private","Location:CN","Telegram","Github","Microsoft","Apple","Social Media","Streaming","Gaming","Education","Financial","Cloud Services","Non-China"]};
            const checkboxes = document.querySelectorAll('.rule-checkbox');
            checkboxes.forEach(checkbox => {
              checkbox.checked = rulesToApply[decodedRules].includes(checkbox.value);
            });
          } else {
            // Handle custom rules (JSON array)
            const rules = JSON.parse(decodedRules);
            if (Array.isArray(rules)) {
              document.getElementById('predefinedRules').value = 'custom';
              const checkboxes = document.querySelectorAll('.rule-checkbox');
              checkboxes.forEach(checkbox => {
                checkbox.checked = rules.includes(checkbox.value);
              });
            }
          }
        } catch (e) {
          console.error('Error parsing selected rules:', e);
        }
      }

      // Parse custom rules
      const customRules = params.get('customRules');
      if (customRules) {
        try {
          const rules = JSON.parse(decodeURIComponent(customRules));
          if (Array.isArray(rules) && rules.length > 0) {
            // Clear existing custom rules
            document.querySelectorAll('.custom-rule').forEach(rule => rule.remove());
            
            // Switch to JSON view and write rules
            switchCustomRulesTab('json');
            const jsonTextarea = document.querySelector('#customRulesJSON textarea');
            if (jsonTextarea) {
              jsonTextarea.value = JSON.stringify(rules, null, 2);
              validateJSONRealtime(jsonTextarea);
            }
          }
        } catch (e) {
          console.error('Error parsing custom rules:', e);
        }
      }

      // Parse configuration ID
      const configId = params.get('configId');
      if (configId) {
        // Fetch configuration content
        fetch(`/config?type=singbox&id=${configId}`)
          .then(response => response.json())
          .then(data => {
            if (data.content) {
              document.getElementById('configEditor').value = data.content;
              document.getElementById('configType').value = data.type || 'singbox';
            }
          })
          .catch(error => console.error('Error fetching config:', error));
      }

      // Show advanced options
      document.getElementById('advancedToggle').checked = true;
      document.getElementById('advancedOptions').classList.add('show');
    } catch (e) {
      console.error('Error parsing URL:', e);
    }
  }

  // æ£€æµ‹æ˜¯å¦æ˜¯çŸ­é“¾
  function isShortUrl(url) {
    try {
      const urlObj = new URL(url);
      const pathParts = urlObj.pathname.split('/');
      return pathParts.length >= 3 && ['b', 'c', 'x', 's'].includes(pathParts[1]) && pathParts[2];
    } catch (error) {
      return false;
    }
  }

  // è‡ªåŠ¨è§£æçŸ­é“¾
  async function autoResolveShortUrl(shortUrl) {
    try {
      const response = await fetch(`/resolve?url=${encodeURIComponent(shortUrl)}`);
      
      if (response.ok) {
        const data = await response.json();
        const originalUrl = data.originalUrl;
        
        // ç”¨åŸå§‹URLæ›¿æ¢è¾“å…¥æ¡†ä¸­çš„çŸ­é“¾
        document.getElementById('inputTextarea').value = originalUrl;
        
        // è§£æåŸå§‹URLåˆ°è¡¨å•
        parseUrlAndFillForm(originalUrl);
        
        return true;
      } else {
        console.error('Failed to resolve short URL:', await response.text());
        return false;
      }
    } catch (error) {
      console.error('Error resolving short URL:', error);
      return false;
    }
  }

  // Add input box event listener
  document.addEventListener('DOMContentLoaded', function() {
    const inputTextarea = document.getElementById('inputTextarea');
    let lastValue = '';
    
    inputTextarea.addEventListener('input', async function() {
      const currentValue = this.value.trim();
      
      if (currentValue && currentValue !== lastValue) {
        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯çŸ­é“¾
        if (isShortUrl(currentValue)) {
          await autoResolveShortUrl(currentValue);
        }
        // ç„¶åæ£€æŸ¥æ˜¯å¦æ˜¯é¡¹ç›®ç”Ÿæˆçš„å®Œæ•´é“¾æ¥
        else if (currentValue.includes('/singbox?') || 
                 currentValue.includes('/clash?') || 
                 currentValue.includes('/surge?') || 
                 currentValue.includes('/xray?')) {
          parseUrlAndFillForm(currentValue);
        }
      }
      
      lastValue = currentValue;
    });
  });

  function loadSavedFormData() {
    const savedInput = localStorage.getItem('inputTextarea');
    if (savedInput) {
      document.getElementById('inputTextarea').value = savedInput;
    }

    const advancedToggle = localStorage.getItem('advancedToggle');
    if (advancedToggle) {
      document.getElementById('advancedToggle').checked = advancedToggle === 'true';
      if (advancedToggle === 'true') {
        document.getElementById('advancedOptions').classList.add('show');
      }
    }
    
    // Load userAgent
    const savedUA = localStorage.getItem('userAgent');
    if (savedUA) {
      document.getElementById('customUA').value = savedUA;
    }
    
    // Load configEditor and configType
    const savedConfig = localStorage.getItem('configEditor');
    const savedConfigType = localStorage.getItem('configType');
    
    if (savedConfig) {
      document.getElementById('configEditor').value = savedConfig;
    }
    if (savedConfigType) {
      document.getElementById('configType').value = savedConfigType;
    }
    
    const savedCustomPath = localStorage.getItem('customPath');
    if (savedCustomPath) {
      document.getElementById('customShortCode').value = savedCustomPath;
    }

    loadSelectedRules();
  }

  function saveSelectedRules() {
    const selectedRules = Array.from(document.querySelectorAll('input[name="selectedRules"]:checked'))
      .map(checkbox => checkbox.value);
    localStorage.setItem('selectedRules', JSON.stringify(selectedRules));
    localStorage.setItem('predefinedRules', document.getElementById('predefinedRules').value);
  }

  function loadSelectedRules() {
    const savedRules = localStorage.getItem('selectedRules');
    if (savedRules) {
      const rules = JSON.parse(savedRules);
      rules.forEach(rule => {
        const checkbox = document.querySelector(`input[name="selectedRules"][value="${rule}"]`);
        if (checkbox) {
          checkbox.checked = true;
        }
      });
    }

    const savedPredefinedRules = localStorage.getItem('predefinedRules');
    if (savedPredefinedRules) {
      document.getElementById('predefinedRules').value = savedPredefinedRules;
    }
  }

  function clearFormData() {
    localStorage.removeItem('inputTextarea');
    localStorage.removeItem('advancedToggle');
    localStorage.removeItem('selectedRules');
    localStorage.removeItem('predefinedRules');
    localStorage.removeItem('configEditor'); 
    localStorage.removeItem('configType');
    localStorage.removeItem('userAgent');
    
    document.getElementById('inputTextarea').value = '';
    document.getElementById('advancedToggle').checked = false;
    document.getElementById('advancedOptions').classList.remove('show');
    document.getElementById('configEditor').value = '';
    document.getElementById('configType').value = 'singbox'; 
    document.getElementById('customUA').value = '';
    
    localStorage.removeItem('customPath');
    document.getElementById('customShortCode').value = '';

    const subscribeLinksContainer = document.getElementById('subscribeLinksContainer');
    subscribeLinksContainer.classList.remove('show');
    subscribeLinksContainer.classList.add('hide');

    document.getElementById('xrayLink').value = '';
    document.getElementById('singboxLink').value = '';
    document.getElementById('clashLink').value = '';

    // wait to reset the container
    setTimeout(() => {
      subscribeLinksContainer.classList.remove('hide');
    }, 500);
  }

  document.addEventListener('DOMContentLoaded', function() {
    loadSavedFormData();
    document.getElementById('encodeForm').addEventListener('submit', submitForm);
    document.getElementById('clearFormBtn').addEventListener('click', clearFormData);
  });

    
  let customRuleCount = 0;
  let currentTab = 'form';

  function switchCustomRulesTab(tab) {
    try {
      currentTab = tab;

      // Update tab buttons
      document.querySelectorAll('.custom-rules-tab').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');

      // Update views
      document.querySelectorAll('.custom-rules-view').forEach(view => view.classList.remove('active'));
      document.getElementById(tab + 'View').classList.add('active');

      // Automatic view conversion
      if (tab === 'json') {
        convertFormToJSON();
      } else {
        convertJSONToForm();
      }

      updateEmptyMessages();
    } catch (error) {
      console.error('Error switching tabs:', error);
      // Ensure the view is correctly displayed if an error occurs during the switch
      document.querySelectorAll('.custom-rules-view').forEach(view => view.classList.remove('active'));
      document.getElementById(tab + 'View').classList.add('active');
    }
  }

  function updateEmptyMessages() {
    const hasFormRules = document.querySelectorAll('.custom-rule').length > 0;
    document.getElementById('emptyFormMessage').style.display = hasFormRules ? 'none' : 'block';
  }

  function addCustomRule() {
    const customRulesDiv = document.getElementById('customRules');
    const newRuleDiv = document.createElement('div');
    newRuleDiv.className = 'custom-rule mb-3 p-3 border rounded';
    newRuleDiv.dataset.ruleId = customRuleCount++;
    newRuleDiv.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Custom Rule #${getNextRuleNumber()}</h6>
        <button type="button" class="btn btn-danger btn-sm" onclick="removeRule(this)">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="row">
        <div class="col-md-6 mb-2">
          <label class="form-label">Outbound Name*</label>
          <input type="text" class="form-control" name="customRuleName[]" placeholder="Outbound Name*" required>
        </div>
        <div class="col-md-6 mb-2">
          <label class="form-label">Geo-Site Rule Set</label>
          <span class="tooltip-icon">
            <i class="fas fa-question-circle"></i>
            <span class="tooltip-content">
              Site rules in SingBox come from https://github.com/lyc8503/sing-box-rules, meaning your custom rules must exist in that repository
            </span>
          </span>
          <input type="text" class="form-control" name="customRuleSite[]" placeholder="e.g.: google,anthropic">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-2">
          <label class="form-label">Geo-IP Rule Set</label>
          <span class="tooltip-icon">
            <i class="fas fa-question-circle"></i>
            <span class="tooltip-content">
              IP rules in SingBox come from https://github.com/lyc8503/sing-box-rules, meaning your custom rules must exist in that repository
            </span>
          </span>
          <input type="text" class="form-control" name="customRuleIP[]" placeholder="e.g.: private,cn">
        </div>
        <div class="col-md-6 mb-2">
          <label class="form-label">Domain Suffix</label>
          <input type="text" class="form-control" name="customRuleDomainSuffix[]" placeholder="Domain suffix (separated by commas)">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-2">
          <label class="form-label">Domain Keyword</label>
          <input type="text" class="form-control" name="customRuleDomainKeyword[]" placeholder="Domain keywords (separated by commas)">
        </div>
        <div class="col-md-6 mb-2">
          <label class="form-label">IP CIDR</label>
          <input type="text" class="form-control" name="customRuleIPCIDR[]" placeholder="IP CIDR (separated by commas)">
        </div>
      </div>
      <div class="mb-2">
        <label class="form-label">Protocol Type</label>
        <span class="tooltip-icon">
          <i class="fas fa-question-circle"></i>
          <span class="tooltip-content">
            Protocol rules for specific traffic types. More info: https://sing-box.sagernet.org/configuration/route/sniff/
          </span>
        </span>
        <input type="text" class="form-control" name="customRuleProtocol[]" placeholder="Protocols (comma-separated, e.g.: http,ssh,dns)">
      </div>
    `;
    customRulesDiv.appendChild(newRuleDiv);
    updateEmptyMessages();

    // Switch to form tab if not already there
    if (currentTab !== 'form') {
      switchCustomRulesTab('form');
    }
  }

  function clearAllCustomRules() {
    if (confirm('Are you sure you want to clear all custom rules?')) {
      document.querySelectorAll('.custom-rule').forEach(rule => rule.remove());
      document.querySelectorAll('.custom-rule-json').forEach(rule => rule.remove());
      customRuleCount = 0; 
      updateEmptyMessages();
    }
  }

  // Add a function to get the next rule number
  function getNextRuleNumber() {
    const existingRules = document.querySelectorAll('.custom-rule');
    return existingRules.length + 1;
  }

  // Modify the remove rule function to update the sequence number
  function removeRule(button) {
    const ruleDiv = button.closest('.custom-rule, .custom-rule-json');
    if (ruleDiv) {
      ruleDiv.remove();
      // Update the sequence number of the remaining rules
      document.querySelectorAll('.custom-rule').forEach((rule, index) => {
        const titleElement = rule.querySelector('h6');
        if (titleElement) {
          titleElement.textContent = `Custom Rule #${index + 1}`;
        }
      });
      updateEmptyMessages();
    }
  }

  function convertFormToJSON() {
    const formRules = [];
    document.querySelectorAll('.custom-rule').forEach(rule => {
      const ruleData = {
        name: rule.querySelector('input[name="customRuleName[]"]').value || '',
        site: rule.querySelector('input[name="customRuleSite[]"]').value || '',
        ip: rule.querySelector('input[name="customRuleIP[]"]').value || '',
        domain_suffix: rule.querySelector('input[name="customRuleDomainSuffix[]"]').value || '',
        domain_keyword: rule.querySelector('input[name="customRuleDomainKeyword[]"]').value || '',
        ip_cidr: rule.querySelector('input[name="customRuleIPCIDR[]"]').value || '',
        protocol: rule.querySelector('input[name="customRuleProtocol[]"]').value || ''
      };

      // Only add rules that have at least a name
      if (ruleData.name.trim()) {
        formRules.push(ruleData);
      }
    });

    // Update JSON editor content
    const jsonTextarea = document.querySelector('#customRulesJSON textarea');
    if (jsonTextarea) {
      jsonTextarea.value = JSON.stringify(formRules, null, 2);
      validateJSONRealtime(jsonTextarea);
    }
  }

  function convertJSONToForm() {
    const jsonTextarea = document.querySelector('#customRulesJSON textarea');
    if (!jsonTextarea || !jsonTextarea.value.trim()) {
      return;
    }

    try {
      const rules = JSON.parse(jsonTextarea.value.trim());
      if (!Array.isArray(rules)) {
        throw new Error('Must be an array format');
      }

      // Clear existing form rules
      document.querySelectorAll('.custom-rule').forEach(rule => rule.remove());

      // Convert each JSON rule to form
      rules.forEach((ruleData, index) => {
        if (ruleData && ruleData.name) {
          const customRulesDiv = document.getElementById('customRules');
          const newRuleDiv = document.createElement('div');
          newRuleDiv.className = 'custom-rule mb-3 p-3 border rounded';
          newRuleDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Custom Rule #${index + 1}</h6>
              <button type="button" class="btn btn-danger btn-sm" onclick="removeRule(this)">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Outbound Name*</label>
                <input type="text" class="form-control" name="customRuleName[]" value="${ruleData.name || ''}" required>
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Geo-Site Rule Set</label>
                <input type="text" class="form-control" name="customRuleSite[]" value="${ruleData.site || ''}">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Geo-IP Rule Set</label>
                <input type="text" class="form-control" name="customRuleIP[]" value="${ruleData.ip || ''}">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Domain Suffix</label>
                <input type="text" class="form-control" name="customRuleDomainSuffix[]" value="${ruleData.domain_suffix || ''}">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Domain Keyword</label>
                <input type="text" class="form-control" name="customRuleDomainKeyword[]" value="${ruleData.domain_keyword || ''}">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">IP CIDR</label>
                <input type="text" class="form-control" name="customRuleIPCIDR[]" value="${ruleData.ip_cidr || ''}">
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Protocol Type</label>
              <input type="text" class="form-control" name="customRuleProtocol[]" value="${ruleData.protocol || ''}">
            </div>
          `;
          customRulesDiv.appendChild(newRuleDiv);
        }
      });
    } catch (error) {
      console.error('Error converting JSON to form:', error);
      // If an error occurs during the conversion, clear the form view
      document.querySelectorAll('.custom-rule').forEach(rule => rule.remove());
    }

    updateEmptyMessages();
  }

  function validateJSONRealtime(textarea) {
    const messageDiv = textarea.parentNode.querySelector('.json-validation-message');
    const jsonText = textarea.value.trim();
    // Clear previous validation state
    textarea.classList.remove('json-valid', 'json-invalid');
    messageDiv.style.display = 'none';
    messageDiv.classList.remove('valid', 'invalid');
    if (!jsonText) {
      return; // Don't validate empty textarea
    }
    try {
      const rules = JSON.parse(jsonText);
      if (!Array.isArray(rules)) {
        throw new Error('Must be an array format');
      }
      const errors = [];
      rules.forEach((ruleData, ruleIndex) => {
        if (!ruleData.name || !ruleData.name.trim()) {
          errors.push(`rule #${ruleIndex + 1}: Rule name is required`);
        }
      });
      if (errors.length > 0) {
        throw new Error(errors.join('; '));
      }
      // Valid JSON
      textarea.classList.add('json-valid');
      messageDiv.textContent = `âœ“ validJSON (${rules.length} rules)`;
      messageDiv.classList.add('valid');
      messageDiv.style.display = 'block';
    } catch (error) {
      // Invalid JSON
      textarea.classList.add('json-invalid');
      messageDiv.textContent = `âœ— ${error.message}`;
      messageDiv.classList.add('invalid');
      messageDiv.style.display = 'block';
    }
  }

  function validateJSON() {
    let allValid = true;
    let errorMessages = [];
    document.querySelectorAll('.custom-rule-json').forEach((rule, index) => {
      const textarea = rule.querySelector('textarea[name="customRuleJSON[]"]');
      validateJSONRealtime(textarea);
      if (textarea.classList.contains('json-invalid')) {
        allValid = false;
        const messageDiv = textarea.parentNode.querySelector('.json-validation-message');
        errorMessages.push(`JSON #${index + 1}: ${messageDiv.textContent.replace('âœ— ', '')}`);
      }
    });
    if (allValid) {
      alert('All JSON rules are valid!');
    } else {
      alert('JSON validation errors:\n\n' + errorMessages.join('\n'));
    }
  }

  function parseCustomRules() {
    const customRules = [];

    // Process ordinary form rules
    document.querySelectorAll('.custom-rule').forEach(rule => {
      const ruleData = {
        name: rule.querySelector('input[name="customRuleName[]"]').value || '',
        site: rule.querySelector('input[name="customRuleSite[]"]').value || '',
        ip: rule.querySelector('input[name="customRuleIP[]"]').value || '',
        domain_suffix: rule.querySelector('input[name="customRuleDomainSuffix[]"]').value || '',
        domain_keyword: rule.querySelector('input[name="customRuleDomainKeyword[]"]').value || '',
        ip_cidr: rule.querySelector('input[name="customRuleIPCIDR[]"]').value || '',
        protocol: rule.querySelector('input[name="customRuleProtocol[]"]').value || ''
      };

      if (ruleData.name.trim()) {
        customRules.push(ruleData);
      }
    });

    // Process JSON rules
    const jsonTextarea = document.querySelector('#customRulesJSON textarea');
    if (jsonTextarea && jsonTextarea.value.trim()) {
      try {
        const jsonRules = JSON.parse(jsonTextarea.value.trim());
        if (Array.isArray(jsonRules)) {
          customRules.push(...jsonRules.filter(r => r.name && r.name.trim()));
        }
      } catch (error) {
        console.error('Error parsing JSON rules:', error);
      }
    }

    return customRules;
  }

  // Initialize interface state
  document.addEventListener('DOMContentLoaded', function() {
    updateEmptyMessages();

    // Initialize real-time validation for JSON textarea
    const jsonTextarea = document.querySelector('#customRulesJSON textarea');
    if (jsonTextarea && jsonTextarea.value.trim()) {
      validateJSONRealtime(jsonTextarea);
    }

    // Initialize tooltips for dynamically added content
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1 && node.querySelectorAll) {
              initTooltips();
            }
          });
        }
      });
    });

    observer.observe(document.getElementById('customRules'), { childList: true, subtree: true });
  });

  function addCustomRuleJSON() {
    const customRulesJSONDiv = document.getElementById('customRulesJSON');
    const newRuleDiv = document.createElement('div');
    newRuleDiv.className = 'custom-rule-json mb-3 p-3 border rounded';
    newRuleDiv.dataset.ruleId = customRuleCount++;
    newRuleDiv.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">JSON Rule</h6>
        <button type="button" class="btn btn-danger btn-sm" onclick="removeRule(this)">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="mb-2">
        <label class="form-label">JSON Rule</label>
        <div class="json-textarea-container">
          <textarea class="form-control json-textarea" name="customRuleJSON[]" rows="15"
                    oninput="validateJSONRealtime(this)"></textarea>
          <div class="json-validation-message" style="display: none;"></div>
        </div>
      </div>
    `;
    customRulesJSONDiv.appendChild(newRuleDiv);
    updateEmptyMessages();
  }

    
  function generateQRCode(id) {
    const input = document.getElementById(id);
    const text = input.value;
    if (!text) {
      alert('No link provided!');
      return;
    }
    try {
      const qr = qrcode(0, 'M');
      qr.addData(text);
      qr.make();

      const moduleCount = qr.getModuleCount();
      const cellSize = Math.max(2, Math.min(8, Math.floor(300 / moduleCount)));
      const margin = Math.floor(cellSize * 0.5);

      const qrImage = qr.createDataURL(cellSize, margin);
      
      const modal = document.createElement('div');
      modal.className = 'qr-modal';
      modal.innerHTML = `
        <div class="qr-card">
          <img src="${qrImage}" alt="QR Code">
          <p>Scan QR Code</p>
        </div>
      `;

      document.body.appendChild(modal);

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeQRModal();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeQRModal();
        }
      });

      requestAnimationFrame(() => {
        modal.classList.add('show');
      });
    } catch (error) {
      console.error('Error in generating:', error);
      alert('Try to use short links!');
    }
  }

  function closeQRModal() {
    const modal = document.querySelector('.qr-modal');
    if (modal) {
      modal.classList.remove('show');
      modal.addEventListener('transitionend', () => {
        document.body.removeChild(modal);
      }, { once: true });
    }
  }

    
  function saveCustomPath() {
    const customPath = document.getElementById('customShortCode').value;
    if (customPath) {
      let savedPaths = JSON.parse(localStorage.getItem('savedCustomPaths') || '[]');
      if (!savedPaths.includes(customPath)) {
        savedPaths.push(customPath);
        localStorage.setItem('savedCustomPaths', JSON.stringify(savedPaths));
        updateSavedPathsDropdown();
      }
    }
  }

  function updateSavedPathsDropdown() {
    const savedPaths = JSON.parse(localStorage.getItem('savedCustomPaths') || '[]');
    const dropdown = document.getElementById('savedCustomPaths');
    dropdown.innerHTML = '<option value="">Saved paths</option>';
    savedPaths.forEach(path => {
      const option = document.createElement('option');
      option.value = path;
      option.textContent = path;
      dropdown.appendChild(option);
    });
  }

  function loadSavedCustomPath() {
    const dropdown = document.getElementById('savedCustomPaths');
    const customShortCode = document.getElementById('customShortCode');
    if (dropdown.value) {
      customShortCode.value = dropdown.value;
    }
  }

  function deleteSelectedPath() {
    const dropdown = document.getElementById('savedCustomPaths');
    const selectedPath = dropdown.value;
    if (selectedPath) {
      let savedPaths = JSON.parse(localStorage.getItem('savedCustomPaths') || '[]');
      savedPaths = savedPaths.filter(path => path !== selectedPath);
      localStorage.setItem('savedCustomPaths', JSON.stringify(savedPaths));
      updateSavedPathsDropdown();
      document.getElementById('customShortCode').value = '';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    updateSavedPathsDropdown();
    document.getElementById('savedCustomPaths').addEventListener('change', loadSavedCustomPath);
  });

    
  function saveConfig() {
    const configEditor = document.getElementById('configEditor');
    const configType = document.getElementById('configType').value;
    const config = configEditor.value;

    localStorage.setItem('configEditor', config);
    localStorage.setItem('configType', configType);
    
    fetch('/config?type=' + configType, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        type: configType,
        content: config
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to save configuration');
      }
      return response.text();
    })
    .then(configId => {
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('configId', configId);
      window.history.pushState({}, '', currentUrl);
      alert('Configuration saved successfully!');
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
  }

    
  function clearConfig() {
    document.getElementById('configEditor').value = '';
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.delete('configId');
    window.history.pushState({}, '', currentUrl);
    localStorage.removeItem('configEditor');
  }

  </script>

  </body>

    </html>
  
